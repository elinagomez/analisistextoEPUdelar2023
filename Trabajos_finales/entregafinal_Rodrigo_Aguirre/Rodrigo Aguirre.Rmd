---
title: "Trabajo final - R aplicado al análisis cualitativo"
author: "Rodrigo Aguirre"
date: "`r Sys.Date()`"
output:
  html_document: default
    df_print: paged
  pdf_document: 
editor_options:
  markdown:
    wrap: 72
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

##### Trabajo final

La base de datos a analizar serán las Circulares de la Corte Electoral disponibles de forma abierta en https://www.impo.com.uy/basecorteelectoral/. Las mismas son comunicaciones que realiza la Corporación de forma de dar a conocer cuestiones relevantes referidas a reglamentaciones aprobadas, modificaciones en la atención al público, integración y conformación de agrupaciones de los partidos políticos, entre otros.  
Se trabajará con las Circulares de los años 1924 a 2017, totalizando casi 100 años. 
Realizando búsquedas por cada año considerado en la web previamente citada es posible obtener el intervalo de Circulares por año y así el número de comunicaciones. Esto servirá para definir los vectores que permitan rescatar las Circulares de la web como se verá a continuación. Asimismo, con el cuadro sobre elecciones de Boreluy se podrá establecer en qué años se celebraron elecciones. Con esta información y los años en los que el gobierno fue dictatorial es posible crear una base de datos primaria sobre circulares:  


```{r, include=FALSE} 
library(rvest)
library(purrr)
library(quanteda)
library(dplyr)
library(ggplot2)
library(rio)
#install.packages("gapminder")
library(gapminder)
```

```{r, include=FALSE}
Serie_circulares = data.frame(
    "anio" = 1924:2021,
    "Cantidad" = c(135-1+1,	289-136+1,	396-290+1,	460-397+1,	591-461+1,	636-592+1,	737-637+1,	850-738+1,	939-851+1,	1036-940+1,	1131-1037+1,	1191-1132+1,	1262-1192+1,	1381-1263+1,	1564-1382+1,	1638-1565+1,	1719-1639+1,	1824-1720+1,	2023-1825+1,	2112-2024+1,	2198-2113+1,	2289-2199+1,	2450-2290+1,	2523-2451+1,	2626-2524+1,	2720-2627+1,	2902-2721+1,	3006-2903+1,	3064-3007+1,	3131-3065+1,	3270-3132+1,	3312-3271+1,	3334-3313+1,	3382-3335+1,	3516-3383+1,	3562-3517+1,	3592-3563+1,	3630-3593+1,	3815-3631+1,	3870-3816+1,	3931-3871+1,	3993-3932+1,	4236-3994+1,	4292-4237+1,	4317-4293+1,	4357-4318+1,	4402-4358+1,	4765-4403+1,	4864-4766+1,	4921-4865+1,	4991-4922+1,	5046-4992+1,	5080-5047+1,	5133-5081+1,	5181-5134+1,	5232-5182+1,	5278-5233+1,	5309-5279+1,	5379-5310+1,	5418-5380+1,	5569-5419+1,	5631-5570+1,	5707-5632+1,	5799-5708+1,	5892-5800+1,	6138-5893+1,	6209-6139+1,	6278-6210+1,	6359-6279+1,	6437-6360+1,	6655-6438+1,	6717-6656+1,	6794-6718+1,	6848-6795+1,	7008-6849+1,	7261-7009+1,	7360-7262+1,	7428-7361+1,	7487-7429+1,	7592-7488+1,	7861-7593+1,	7949-7862+1,	8014-7950+1,	8080-8015+1,	8173-8081+1,	8528-8174+1,	8662-8529+1,	8781-8663+1,	8907-8782+1,	9068-8908+1,	9438-9069+1,	9686-9439+1,	9819-9687+1,	9961-9820+1,	10183-9962+1,	10714-10184+1,	11097-10715+1,	11264-11098+1),
    "Dictadura" = c(0,	0,	0,	0,	0,	0,	0,	0,	0,	1,	1,	1,	1,	1,	1,	0,	0,	0,	0,	0,	0,	0,	0,	0,	0,	0,	0,	0,	0,	0,	0,	0,	0,	0,	0,	0,	0,	0,	0,	0,	0,	0,	0,	0,	0,	0,	0,	0,	0,	1,	1,	1,	1,	1,	1,	1,	1,	1,	1,	1,	1,	0,	0,	0,	0,	0,	0,	0,	0,	0,	0,	0,	0,	0,	0,	0,	0,	0,	0,	0,	0,	0,	0,	0,	0,	0,	0,	0,	0,	0,	0,	0,	0,	0,	0,	0,	0,	0),
    "Ano_electoral" = c(0,	1,	1,	0,	1,	0,	1,	1,	1,	0,	1,	0,	0,	0,	1,	0,	0,	0,	1,	0,	0,	0,	1,	0,	0,	0,	1,	0,	0,	0,	1,	0,	0,	0,	1,	0,	0,	0,	1,	0,	0,	0,	1,	0,	0,	0,	0,	1,	0,	0,	0,	0,	0,	0,	0,	0,	0,	0,	0,	0,	1,	0,	0,	0,	0,	0,	0,	0,	0,	0,	0,	0,	0,	0,	0,	1,	1,	0,	0,	0,	1,	1,	0,	0,	0,	1,	1,	0,	0,	0,	1,	1,	0,	0,	0,	1,	1,	0)
  )  

```

```{r, echo = FALSE}
ggplot(data=Serie_circulares, aes(x = anio, y = Cantidad)) +
  geom_line(size = 1) +
  geom_point(color = 'red', size = 2) +
  labs(x = "", y = "", title = "Total de Circulares por año")
```

Esta sola información permitiría en principio realizar un análisis basado en series de tiempo para detectar niveles de medias, ciclos y tendencias de la serie a la vez que predecir valores futuros. No se explorará esa línea de investigación, sino que esta información se incorporará más adelante para la evaluación del contenido cualitativo de las circulares en función de la categoría "Año electoral" o "Dictadura". Otra forma de agrupar a las Circulares y por ende, de definir la unidad de análisis, podría ser las distintas integraciones de la Corte Electoral, los distintos regímenes de gobierno (colegiado, unipersonal), los períodos determinados por el gobierno bajo distintos partidos políticos, entre otros. 
Probablemente, no todas estas categorías resulten relevantes para explicar diferencias cuantitativas y/o cualitativas entre períodos pero bien valdría la pena testearlo. Vale la pena comentar que si bien la página web ofrece distintas categorías para clasificar la documentación, para el caso de las circulares no se encuentran categorizadas. 
Volviendo al tema, prosigo creando los vectores que servirán para el analísis cualitativo de los textos.  

```{r, include=FALSE}
vector1924=as.character(c(-1924, 135:1))
vector1925=as.character(c(-1925, 289:136))
vector1926=as.character(c(-1926, 396:290))
vector1927=as.character(c(-1927, 460:397))
vector1928=as.character(c(-1928, 591:461))
vector1929=as.character(c(-1929, 636:592))
vector1930=as.character(c(-1930, 737:637))
vector1931=as.character(c(-1931, 850:738))
vector1932=as.character(c(-1932, 939:851))
vector1933=as.character(c(-1933, 1036:940))
vector1934=as.character(c(-1934, 1131:1037))
vector1935=as.character(c(-1935, 1191:1132))
vector1936=as.character(c(-1936, 1262:1192))
vector1937=as.character(c(-1937, 1381:1263))
vector1938=as.character(c(-1938, 1564:1382))
vector1939=as.character(c(-1939, 1638:1565))
vector1940=as.character(c(-1940, 1719:1639))
vector1941=as.character(c(-1941, 1824:1720))
vector1942=as.character(c(-1942, 2023:1825))
vector1943=as.character(c(-1943, 2112:2024))
vector1944=as.character(c(-1944, 2198:2113))
vector1945=as.character(c(-1945, 2289:2199))
vector1946=as.character(c(-1946, 2450:2290))
vector1947=as.character(c(-1947, 2523:2451))
vector1948=as.character(c(-1948, 2626:2524))
vector1949=as.character(c(-1949, 2720:2627))
vector1950=as.character(c(-1950, 2902:2721))
vector1951=as.character(c(-1951, 3006:2903))
vector1952=as.character(c(-1952, 3064:3007))
vector1953=as.character(c(-1953, 3131:3065))
vector1954=as.character(c(-1954, 3270:3132))
vector1955=as.character(c(-1955, 3312:3271))
vector1956=as.character(c(-1956, 3334:3313))
vector1957=as.character(c(-1957, 3382:3335))
vector1958=as.character(c(-1958, 3516:3383))
vector1959=as.character(c(-1959, 3562:3517))
vector1960=as.character(c(-1960, 3592:3563))
vector1961=as.character(c(-1961, 3630:3593))
vector1962=as.character(c(-1962, 3815:3631))
vector1963=as.character(c(-1963, 3870:3816))
vector1964=as.character(c(-1964, 3931:3871))
vector1965=as.character(c(-1965, 3993:3932))
vector1966=as.character(c(-1966, 4236:3994))
vector1967=as.character(c(-1967, 4292:4237))
vector1968=as.character(c(-1968, 4317:4293))
vector1969=as.character(c(-1969, 4357:4318))
vector1970=as.character(c(-1970, 4402:4358))
vector1971=as.character(c(-1971, 4765:4403))
vector1972=as.character(c(-1972, 4864:4766))
vector1973=as.character(c(-1973, 4921:4865))
vector1974=as.character(c(-1974, 4991:4922))
vector1975=as.character(c(-1975, 5046:4992))
vector1976=as.character(c(-1976, 5080:5047))
vector1977=as.character(c(-1977, 5133:5081))
vector1978=as.character(c(-1978, 5181:5134))
vector1979=as.character(c(-1979, 5232:5182))
vector1980=as.character(c(-1980, 5278:5233))
vector1981=as.character(c(-1981, 5309:5279))
vector1982=as.character(c(-1982, 5379:5310))
vector1983=as.character(c(-1983, 5418:5380))
vector1984=as.character(c(-1984, 5569:5419))
vector1985=as.character(c(-1985, 5631:5570))
vector1986=as.character(c(-1986, 5707:5632))
vector1987=as.character(c(-1987, 5799:5708))
vector1988=as.character(c(-1988, 5892:5800))
vector1989=as.character(c(-1989, 6138:5893))
vector1990=as.character(c(-1990, 6209:6139))
vector1991=as.character(c(-1991, 6278:6210))
vector1992=as.character(c(-1992, 6359:6279))
vector1993=as.character(c(-1993, 6437:6360))
vector1994=as.character(c(-1994, 6655:6438))
vector1995=as.character(c(-1995, 6717:6656))
vector1996=as.character(c(-1996, 6794:6718))
vector1997=as.character(c(-1997, 6848:6795))
vector1998=as.character(c(-1998, 7008:6849))
vector1999=as.character(c(-1999, 7261:7009))
vector2000=as.character(c(-2000, 7360:7262))
vector2001=as.character(c(-2001, 7428:7361))
vector2002=as.character(c(-2002, 7487:7429))
vector2003=as.character(c(-2003, 7592:7488))
vector2004=as.character(c(-2004, 7861:7593))
vector2005=as.character(c(-2005, 7949:7862))
vector2006=as.character(c(-2006, 8014:7950))
vector2007=as.character(c(-2007, 8080:8015))
vector2008=as.character(c(-2008, 8173:8081))
vector2009=as.character(c(-2009, 8528:8174))
vector2010=as.character(c(-2010, 8662:8529))
vector2011=as.character(c(-2011, 8781:8663))
vector2012=as.character(c(-2012, 8907:8782))
vector2013=as.character(c(-2013, 9068:8908))
vector2014=as.character(c(-2014, 9438:9069))
vector2015=as.character(c(-2015, 9686:9439))
vector2016=as.character(c(-2016, 9819:9687))
vector2017=as.character(c(-2017, 9961:9820))
vector2018=as.character(c(-2018, 10183:9962))
vector2019=as.character(c(-2019, 10714:10184))
vector2020=as.character(c(-2020, 11097:10715))
vector2021=as.character(c(-2021, 11264:11098))
```  

Luego agrupo los vectores en una lista y creo un bucle que permita rescatar en distintos archivos ".Rdata" las circulares por año.

```{r, include=FALSE}
circular <- list(vector1924,vector1925,vector1926,vector1927,vector1928,vector1929,vector1930,vector1931,vector1932,vector1933,vector1934,vector1935,vector1936,vector1937,vector1938,vector1939,vector1940,vector1941,vector1942,vector1943,vector1944,vector1945,vector1946,vector1947,vector1948,vector1949,vector1950,vector1951,vector1952,vector1953,vector1954,vector1955,vector1956,vector1957,vector1958,vector1959,vector1960,vector1961,vector1962,vector1963,vector1964,vector1965,vector1966,vector1967,vector1968,vector1969,vector1970,vector1971,vector1972,vector1973,vector1974,vector1975,vector1976,vector1977,vector1978,vector1979,vector1980,vector1981,vector1982,vector1983,vector1984,vector1985,vector1986,vector1987,vector1988,vector1989,vector1990,vector1991,vector1992,vector1993,vector1994,vector1995,vector1996,vector1997,vector1998,vector1999,vector2000,vector2001,vector2002,vector2003,vector2004,vector2005,vector2006,vector2007,vector2008,vector2009,vector2010,vector2011,vector2012,vector2013,vector2014,vector2015,vector2016,vector2017,vector2018,vector2019,vector2020,vector2021)
```
Este es el código principal que permite recoger las Circulares:
```{r eval=FALSE, include=FALSE}
circulares=list()
    
for (i in 1:length(circular)){
      
      circulares[[i]] <- purrr::map(as.character(circular[[i]][2:length(circular[[i]])]),~
                                      paste0("https://impo.com.uy/bases/circulares-corte-electoral/",.,circular[[i]][1])) %>%
        unlist() %>% 
        map(possibly(~ .x %>% 
                       read_html() %>% 
                       html_elements(".column") %>%
                       html_text() %>% 
                       unlist() %>% 
                       as.data.frame(),otherwise = NULL)) %>% 
        unlist() %>%
        as.data.frame()
      
      
      out <- circulares[[i]]
      save(out,file = paste0("Circulares - Ano",circular[[i]][1],".RData"))
      
} 
save(circulares,file = "Circulares.RData")

```

Para finalizar, guardo el archivo con todas las circulares. Como correr el código podría llevar algo de tiempo, cargo los archivos para obtener los resultados gráficos.  

```{r, include = FALSE}
load("~/Rodrigo/Educación Permanente/R aplicado al análisis cualitativo/Curso cuali/Circulares.RData") 
```
Realizo el merge entre las dos bases de datos para poder hacer nubes de palabras distinguiendo grupos.

```{r include=FALSE}
bucle=list()
for (i in 1:length(circulares)){
  
circulares[[i]]$anio = 1923 + i # Creo la variable año para el data.frame que me habilitará a realizar el merge

bucle[[i]] <- merge(circulares[[i]], Serie_circulares, by = "anio") %>%
as.data.frame() 
}
```

```{r}
dfm <- quanteda::dfm(quanteda::tokens(as.character(circulares),
                                      remove_punct = TRUE,
                                      remove_numbers = TRUE),
                     tolower=TRUE,
                     verbose = FALSE) %>%
  quanteda::dfm_remove(pattern = c(quanteda::stopwords("spanish"), "corte", "electoral", "montevideo", "circular", "secretario", "letrado", "presidente", "replace", "url", "css", "attr", "tooltip", "popover", "href", "function", "exitform", "data-toggle", "click", "background-image", "#url_logo", "#logo_interfaz", "#formlista", "#ayudadocumento", "tcircular", "undefined", "twindow.location", "trigger", "thistory.back", "tfunction", "tayuda", "submit", "html", "event", "else", "#botonsalir", "#botonlista", "tif", "src", "logout.cgi", "font-family", "cgi-bin", "tver", "usted", "atentamente", "hojas", "señor"),min_nchar=3)
# elimino palabras que no tienen un significado particular.


#  quanteda::dfm_group(dfm, groups = bucle[[1]]$Ano_electoral)

```

```{r include=FALSE}

grafico <- quanteda.textplots::textplot_wordcloud(quanteda::dfm(dfm), min.count = 10,max_words = 100,random.order = TRUE,rot.per = .25, colors = c("#954342"),comparison = F)

```

## Palabras más utilizadas

Creo un objeto con las 20 principales palabras y las defino como nombres de filas

```{r echo=TRUE}
top = data.frame(topfeatures(dfm,20))
top$palabra = rownames(top)
```

A continuación hago el gráfico con ggplot
```{r echo=FALSE}
topplot = top[1:20, ] %>%
  ggplot(aes(x = reorder(palabra, topfeatures.dfm..20.), 
             y = topfeatures.dfm..20., fill = palabra)) + 
  geom_col(show.legend = FALSE) +
  coord_flip() +
  geom_text(aes(hjust = -0.1, label = topfeatures.dfm..20.)) +
  theme_minimal() +
  theme(axis.title.y = element_blank(), axis.title.x = element_blank(), axis.text = element_text(size = 15)) +
  ggtitle("Palabras más frecuentes (n=20)") +
  scale_fill_manual(values = c(rep("#D7B5D8",20)))

topplot
# vemos el gráfico
```

## Asociación de palabras

Vemos por ejemplo con qué palabras se relaciona "acuerdo". 
```{r echo=FALSE, warning=FALSE}
relacion_palabras <- quanteda.textstats::textstat_simil(dfm,selection = "acuerdo",
                                   method = "correlation",margin = "features")%>%
  as.data.frame()%>%
  dplyr::arrange(-correlation)%>%
  dplyr::top_n(15)
  
```

## KWIC

```{r}
kwic = quanteda::kwic(quanteda::tokens(as.character(dfm),
                                       remove_punct = TRUE,
                                       remove_numbers = TRUE), 
                      pattern = quanteda::phrase(c("acuerdo")),
                      window = 10)# 5 palabras antes y 5 palabras después

# install.packages("DT")
Kwic <- DT::datatable(kwic)
# No sé por qué no permite ver el resultado
# lo puedo pensar como una nueva unidad de análisis
```


















