---
title: "Trabajo Final R Cuali"
author: "Joaquín Alonso"
date: "2023-02-12"
output:
  word_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

En el presente trabajo se analiza el diario de sesión del senado del 13/04/2021 cuando la cámara trató temas relativos a la pandemia y a la creación de impuesatos para el Fondo Covid. Los senadores esgrimieron argumentos a favor y en contra de impuestos transitorios a funcionarios públicos, depósitos en el exterior y a privados; los cuales serán analizados a continuación. 

1) La fuente de datos es el scrapeo del diario de sesión parlamentaria que realizamos mediante el paquete speech(). En adición, le pegaremos las etiquetas partidarias mediante el paquete puy(). 

```{r}

library(remotes)
library(puy)
library(speech)



sesion <- speech_build(file = "C:/Users/Usuario/Documents/rcuali2022/Trabajos finales/trabajofinalcursoepraplicadoalanlisiscualitativo_JoquinAlonso/diario_sesion.pdf",compiler = T)
sesion = puy::add_party(sesion)
```

A continuación utilizaremos el paquete quanteda para poder limpiar los datos, organizarlos en un dfm y poder realizar minería de texto. Lo haremos para todo el diario de sesión. 

```{r}
library(quanteda) 
library(readtext) 
library(stringr)
library(dplyr)
library(ggplot2)
library(quanteda.textstats)
library(quanteda.textplots)
library(dplyr)


dfm_sesion <- dfm(tokens(sesion$speech,
                         remove_punct = TRUE,
                         remove_numbers = TRUE),
                                 tolower=TRUE,
                                 verbose = FALSE) %>%
  quanteda::dfm_remove (pattern = c(quanteda::stopwords("spanish"),"seño*","presidente"),min_nchar=3)%>%
  quanteda::dfm_trim(min_termfreq = 4)%>% 
  quanteda::dfm_group(groups = sesion$party)



View(as.data.frame(dfm_sesion))


```

A continuación realizaremos alguna técnicas de minería de texto para familiarizarnos con el documento. Primero crearemos un diccionario para poder clasificar temáticamente el texto y en segundo lugar exploraremos la asociación de palabras poniendo el foco en la palabra "impuesto"

```{r}

midic <- dictionary(list(impuestos = c("contribución","ayuda", "depósitos","funcionarios públicos", "impuesto*","impositivo", "redistribución", "tributo*","tienen más"),
           salud=c("pandemia","covid19","sistema de salud","vacuna*", "médicos", "personal de salud", "muertos","enfermo*")))

midic_sesion<-dfm_lookup(dfm_sesion,dictionary=midic,nomatch="no_aparece")
midic_sesion_=convert(midic_sesion, to = "data.frame") 
View(midic_sesion_)

```

El diccionario nos permite observar que impuestos es una temática más relevante que salud en la sesión y que la magnitud de las intervenciones del Frente Amplio y del Partido Nacional fueron simlares. 


A continuación vamos a visualizar las 20 palabras mencionadas con mayor frecuencia asitiendonos con un gráfico: 


```{r}
top = data.frame(topfeatures(dfm_sesion,20))

top$palabra = rownames(top)

topplot = top[1:20, ] %>%
  ggplot(aes(x = reorder(palabra, topfeatures.dfm_sesion..20.), 
             y = topfeatures.dfm_sesion..20., fill = palabra)) + 
  geom_col(show.legend = FALSE) +
  coord_flip() +
  geom_text(aes(hjust = -0.1, label = topfeatures.dfm_sesion..20.)) +
  theme_minimal() +
  theme(axis.title.y = element_blank(), axis.title.x = element_blank(), axis.text = element_text(size = 15)) +
  ggtitle("Palabras más frecuentes (n=20)") +
  scale_fill_manual(values = c(rep("#D7B5D8",20)))

topplot

```
Se observa que efectivamente la palabra "impuesto" es la más mencionada. También podemos intuir que el factor "patrimonio" estuvo sobre la mesa en la discusión. 

Acontinuación haremos una segunda visualización con una nube de las palabras más mencionadas agrupadas por partido: 


```{r}

quanteda.textplots::textplot_wordcloud(dfm_sesion, min.count = 10,max_words = 200,
                                       random.order = FALSE,colors = RColorBrewer::brewer.pal(8,"Dark2"),comparison = T)


```

Se observa las distintas categorías que utiliza cada partido para poner el foco en los sujetos: "personas" o "gente" (PN), trabajadores (FA), compatriotas (PC). También se observa que en el FA hay una apelación a "medidas",  "crisis" y "pobreza", por ejemplo, mientras que en el PC hay apelaciones a los "uruguayos", al "ejecutivo" y a nociones de tiempo, mientras que en el PN hay apelaciones a "impuesto", "funcionarios" (da indicio de que fue el partido que propuso el impuesto a los funcionarios públicos) y "personas". 

A continuación vamos a realizar una codificación manual de un segmento de la sesión donde se discutió el tema impositivo. Utilizaremos el paquete RQDA() por lo que copiamos y pegamos el segmento en cuestión en los archivos txt sesión y sesión2 que luego ingresaremos como files en el paquete. 

```{r}
library(RQDA)

RQDA()

tabla_cods=getCodingTable()

tabla=RQDA::getCodingTable()

out = vector("list", length = max(tabla$cid))

for(i in 1:max(tabla$cid)) {         
  out[[i]] <- rbind(RQDA::getCodingsByOne(i) )
  
}

data = do.call(rbind, out)


```
Le pegamos las citas a la tabla y tendremos como producto final datos textuales tabulados con los argumentos a favor y en contra de los impuestos propuestos. 

out = vector("list", length = max(tabla$cid))

for(i in 1:max(tabla$cid)) {         
  out[[i]] <- rbind(RQDA::getCodingsByOne(i) )
  
}

data = do.call(rbind, out)

