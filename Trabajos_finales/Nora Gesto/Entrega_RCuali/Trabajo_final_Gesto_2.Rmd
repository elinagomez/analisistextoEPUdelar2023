---
title: "Entrega del Trabajo Final del Curso de R aplicado al Análisis Cualitativo"
author: "Nora Gesto"
date: "30/9/2021"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Introducción

El presente documento se realiza en el marco del trabajo final del curso de R para el análisis cualitativo. 
Se presentará en diferentes apartados la aplicación de algunas de las técnicas vistas en el curso, manteniendo como hilo conductor el tema de las **educación**.

# Procesamiento de archivos pdf desde la web

En primer instancia se utiliza la técnica de procesamiento de datos proveniente de archivos en pdf, digitalizados y extrayendo las tablas e información contenida en los mismos para sistematizar esos datos en indicadores y graficarlos.

Para esta parte del trabajo se van a utilizar informes del **Monitor Educativo del CES**, en el cual se presentan los informes de cada liceo con información de matriculación y aprobación en cada año.

Se toma a los efectos de hacer un ejercicio de ejemplo simple solo al departamento de Flores. 

La complejidad está en que cada liceo presenta la información en un archivo pdf con la información mezclada para varones y mujers y para procesarla de forma separada es necesario extraerla de las tablas. Una vez extraída la información de las tablas, se puede presentar la información por liceo y por ciclo diferenciado para mujer y varón y la evolución que ha tenído en la matrícula la participación de las mujeres en los últimos años.

```{r message=FALSE, warning=FALSE, include=FALSE}
#Levanto datos de promoción del Monitor Educativo del CES

library(pdftools)
#Determinamos el pdf con el que trabajar
flores_601 <- "https://servicios.ces.edu.uy/monitorces/servlet/ainformecb2006?L,601"
flores_602 <- "https://servicios.ces.edu.uy/monitorces/servlet/ainformecb2006?L,602"
flores_603 <- "https://servicios.ces.edu.uy/monitorces/servlet/ainformecb2006?L,603"


#Extraemos el texto
txt1 <- pdf_text(flores_601)

#Concatenamos el texto
cat(txt1)
cat(txt1[1])
cat(txt1[7])

matricula_1 = tabulizer::extract_tables(flores_601)[[3]]
matricula_2 = tabulizer::extract_tables(flores_602)[[3]]
matricula_3 = tabulizer::extract_tables(flores_603)[[3]]

#Evolución de la Matriculación en el departamento

flores=as.matrix(rbind(as.numeric(matricula_1[2,2:9]),
                       as.numeric(matricula_2[2,2:9]),as.numeric(matricula_3[2,2:9])))
flores=data.frame(rbind(flores,colSums(flores)))
rownames(flores)=c("Flores dptal","Ismael Cortinas","Flores nro2","Total")
anio=c(2014,2015,2016,2017,2018,2019,2020,2021)
colnames(flores)=anio


f=c(as.numeric(matricula_1[2,2:9]),
  as.numeric(matricula_2[2,2:9]),as.numeric(matricula_3[2,2:9]))
flores=data.frame(rep(anio,3),
                  c(rep("Flores dptal",8),rep("Ismael Cortinas",8),rep("Flores nro2",8)),
                  f)
colnames(flores)=c("anio","Liceo","Matriculados")
a=aggregate(flores$Matriculados,by=list(flores$anio),sum)

flores=rbind(flores,cbind(anio,Liceo=rep("Total",8),Matriculados=a$x))

#Matriculación por sexo
sexo_1 = tabulizer::extract_tables(flores_601)[[5]]
sexo_2 = tabulizer::extract_tables(flores_602)[[5]]
sexo_3 = tabulizer::extract_tables(flores_603)[[5]]

s=rbind(sexo_1[,6:10],sexo_2[,6:10],sexo_3[,6:10])
s=s[-c(1,2,7,8,13,14),]

mm=matrix(0,ncol=4,nrow=12)
hh=matrix(0,ncol=4,nrow=12)
for(i in 1:3){
mm[,i]= as.numeric(substr(s[,i],1,5))
hh[,i]= as.numeric(substr(s[,i],6,11)) 
}

n=c("1CB","2CB","3CB","CBT")
l=c(rep("Flores dptal",4),rep("Ismael Cortinas",4),rep("Flores nro2",4))
colnames(mm)=c(2018,2019,2020,2021)
mm=data.frame(liceo=l,ciclo=rep(n,3),mm)
mm$X2021=as.numeric(s[,4])

colnames(hh)=c(2018,2019,2020,2021)
hh=data.frame(liceo=l,ciclo=rep(n,3),hh)
hh$X2021=as.numeric(s[,5])

mm
hh

cbt=colSums(mm[mm$ciclo=="CBT",c(3:6)])+
  colSums(hh[hh$ciclo=="CBT",c(3:6)])

m0=colSums(mm[mm$ciclo=="CBT",c(3:6)])/
  (
colSums(mm[mm$ciclo=="CBT",c(3:6)])+
colSums(hh[hh$ciclo=="CBT",c(3:6)]))


m1=colSums(mm[mm$ciclo=="1CB",c(3:6)])/
  (
    colSums(mm[mm$ciclo=="1CB",c(3:6)])+
      colSums(hh[hh$ciclo=="1CB",c(3:6)]))

m2=colSums(mm[mm$ciclo=="2CB",c(3:6)])/
  (
    colSums(mm[mm$ciclo=="2CB",c(3:6)])+
      colSums(hh[hh$ciclo=="2CB",c(3:6)]))

m3=colSums(mm[mm$ciclo=="3CB",c(3:6)])/
  (
    colSums(mm[mm$ciclo=="3CB",c(3:6)])+
      colSums(hh[hh$ciclo=="3CB",c(3:6)]))
m0;m1;m2;m3

t=round(rbind(m0,m1,m2,m3),4)*100
rownames(t)=c("CBT","1CB","2CB","3CB")

```

```{r echo=FALSE, message=FALSE, warning=FALSE}

knitr::kable(cbt, caption = "Matrícula total en Ciclo Básico en Flores")

knitr::kable(mm, caption = "Matrícula de Mujeres")

knitr::kable(hh, caption = "Matrícula de Varones")

knitr::kable(t, caption = "% de Matriculación Femenina")

```

```{r}

tabla=as.data.frame(t)
tabla$ciclo=rownames(tabla)
tabla=melt(tabla,id.vars="ciclo")
tabla$variable=gsub("X","",tabla$variable)
colnames(tabla)=c("Ciclo","Año","Per")
tabla$Ciclo=factor(tabla$Ciclo,labels = c("CBT","1CB","2CB","3CB"))


ggplot(tabla, aes(x=Ciclo, y=Per, fill=Año)) +
  geom_bar(stat="identity", position="dodge", colour="black") +
  scale_fill_brewer(type="qual", palette=1)+
  coord_flip()+
  ggtitle("% MATRICULACIÓN FEMENINA")


```

<!-- ![]("gr1.pdf") -->


El dato más destacable es el decenso de la matriculación de las mujeres medido respecto a los varones en el ciclo básico en los últimos cuatro años en el departamento de Flores.

Si bien es positivo que haya menos deserción por parte de los varones, es un fenómeno peculiar que las mujeres aumentan su matriculación respecto a los varones en primer año de ciclo básico y luego disminuye en los siguientes años de ciclo básico.

# Análisis de Titulares de la web

```{r message=FALSE, warning=FALSE, include=FALSE}
library(rvest)
library(dplyr)

##mode:"ArtList" (listado de artículos)

articulos  = gdeltr2::ft_v2_api(
  terms = c("Robert Silva"),
  modes = c("ArtList"),
  visualize_results = F,
  timespans = "365 days",
  source_countries = "UY"
) 

articulos$d=ifelse(duplicated(articulos$titleArticle)==TRUE,1,0)
articulos=articulos[articulos$d==0,]
R=length(articulos$titleArticle)

articulos2  = gdeltr2::ft_v2_api(
  terms = c("Anep"),
  modes = c("ArtList"),
  visualize_results = F,
  timespans = "365 days",
  source_countries = "UY"
)

articulos2$d=ifelse(duplicated(articulos2$titleArticle)==TRUE,1,0)
articulos2=articulos2[articulos2$d==0,]
A=length(articulos2$titleArticle)

dominio=cbind(
as.matrix(addmargins(table(articulos2$domainArticle))),
as.matrix(round(addmargins(prop.table(table(articulos2$domainArticle))),4)*100))

web1=rownames(dominio[-nrow(dominio),])
web2=ifelse(web1=="carasycaretas.com.uy","carasycaretas","Otros")
web2=ifelse(web1=="elpais.com.uy","elpais",web2)
web2=ifelse(web1=="ladiaria.com.uy","ladiaria",web2)
web2=ifelse(web1=="republica.com.uy","republica",web2)
web2=ifelse(web1=="elobservador.com.uy","elobservador",web2)

```
Utilizando el **proyecto GDELT** se recopilan los titulares de la web de los últimos 365 días en los cuales se hacen menciones de ANEP y de Robert Silva, y se identifica el tono de los mismos (si son menciones positivas o negativas).

Se capturan un total de `r A` menciones de ANEP siendo la mayoría en **elpais.com.uy** y **ladiaria.com.uy** y `r R` menciones de Robert Silva.

```{r echo=FALSE, message=FALSE, warning=FALSE}

knitr::kable(dominio, caption = "Cantidad de menciones de ANEP", col.names = c("Menciones","%"))
```


```{r echo=FALSE, message=FALSE, warning=FALSE,out.width = "70%",fig.cap="",fig.align="center"}
library(ggplot2)

# Create Data
data <- data.frame(web=rownames(dominio[-nrow(dominio),]),percent=dominio[-nrow(dominio),2])
data2 <- data.frame(web=web2,percent=dominio[-nrow(dominio),2])

# Basic piechart
ggplot(data2, aes(x="", y=percent, fill=web)) +
  geom_bar(stat="identity", width=1, color="white") +
  geom_text(aes(label = percent),
            position = position_stack(vjust = 0.5)) +
  coord_polar(theta = "y") +
  theme(axis.text = element_blank(),
        axis.ticks = element_blank(),
        axis.title = element_blank(),
        panel.grid = element_blank(),
        panel.background = element_rect(fill = "#ebf2ff"),
        plot.background = element_rect(fill = "#ebf2ff"),
        legend.background = element_rect(fill = "#ebf2ff"))+
  ggtitle ("Menciones de ANEP en los diarios web")

  #theme_void() # remove background, grid, numeric labels

```


```{r message=FALSE, warning=FALSE, include=FALSE}

tonos = gdeltr2::ft_v2_api(
  terms = c("Robert Silva"),
  modes = c("TimelineTone"),
  visualize_results = F,
  timespans = "365 days",
  source_countries = "UY"
) 


tonos1 = gdeltr2::ft_v2_api(
  terms = c("Anep"),
  modes = c("TimelineTone"),
  visualize_results = F,
  timespans = "365 days",
  source_countries = "UY"
) 

library(lubridate)
tonos$datetimeData=as_date(tonos$datetimeData)
tonos1$datetimeData=as_date(tonos1$datetimeData)

```

En cuanto al tono, el proyecto GDELT con su algoritmo le asigna un tono, positivo o negativo al artículo encontrado, con lo cual, genera un índice para cada artículo en estos 365 días de búsqueda solicitados.

El Índice promedio vinculado al tono de los titulares de los artículos buscados para **ANEP** tiene un valor de `r round(mean(tonos1$value),3)` y los vinculados a **Robert Silva** de `r round(mean(tonos$value),3)`. Siendo su interpretación que si el valor es menor a cero es un tono negativo y si es superior a cero es positivo.

```{r echo=FALSE, message=FALSE, warning=FALSE}

knitr::kable(rbind(RS=round(summary(tonos$value),3),
      ANEP=round(summary(tonos1$value),3)), caption = "Estadísticas descriptivas del índice medio del tono en las menciones")
```


```{r echo=FALSE, message=FALSE, warning=FALSE,out.width = "80%",fig.cap="",fig.align="center"}

ggplot(data=tonos[,10:11], aes(x=tonos$datetimeData, y=tonos$value))+
  geom_line(y=tonos$value,colour="darkgreen")+
  geom_line(y=mean(tonos$value),colour="red")+
  ggtitle("Tono Promedio de las menciones a Robert Silva en Titulares") +
  labs(caption = "Línea roja: promedio del tono de las menciones.")+
  ylab("Tono de las menciones") + xlab("Fecha") +
#  xlim(5, 7)+
  ylim(-5, 5)

ggplot(data=tonos1[,10:11], aes(x=tonos1$datetimeData, y=tonos1$value))+
  geom_line(y=tonos1$value,colour="darkblue")+
  geom_line(y=mean(tonos1$value),colour="red")+
  ggtitle("Tono Promedio de las menciones a ANEP en Titulares") +
  labs(caption = "Línea roja: promedio del tono de las menciones.")+
  ylab("Tono de las menciones") + xlab("Fecha") +
#  xlim(5, 7)+
  ylim(-7, 5)


```

Se observa en las gráficas una marcada negatividad en los índices de ambos en el entorno del comienzo de clases y abril 2021, período en que hubo conflictos por el inicio de clases, la alimentación en las escuelas y un paro.

\newpage

A continuación se presenta una **nube de palabras** construída con los titulares recogidos en las `r A` menciones de ANEP, lo cual permite destacar las palabras más repetidas y relevantes en los mismos.

```{r echo=FALSE, message=FALSE, warning=FALSE}
library(quanteda) 
library(readtext) 
library(stringr)
library(dplyr)
library(ggplot2)
library(quanteda.textstats)

corpus <- corpus(articulos2$titleArticle)

tokens <- tokens(corpus, remove_punct = TRUE,remove_numbers = TRUE)

tokens <- tokens_select(tokens, pattern = stopwords("spanish"), selection = "remove")

dfm <- dfm(tokens,
           tolower = TRUE,
           remove_punct = TRUE,
           remove_numbers = TRUE,
           remove = c(stopwords("spanish"))) %>%
  dfm_remove(min_nchar=3) %>%
  dfm_trim(min_termfreq = 50, min_docfreq = 2)

textplot_wordcloud(dfm, min.count = 3,max_words = 150,random.order = TRUE,
                   rot.per = .50, colors = RColorBrewer::brewer.pal(8,"Dark2"))

```


# Análisis comparado de los sentimientos de los Titulares de la web con otros paquetes.

Se utiliza el paquete **syuzhet** para detectar sentimientos en los titulares que se descargaron de la web y hacer el comparado con el algoritmo propio del proyecto GDELT.

El paquete **syuzhet** clasifica las palabras de los titulares en 10 dimensiones y les asigna un puntaje si lo tiene mayor a cero o nada. 
En función de esas dimensiones, para este trabajo se reclasificaron las mismas en positivas, negativas y neutrales, no se encontraron menciones neutrales con lo cual se grafican solo los valores de la suma de las positivas y las negativas. 

Se agrupan como dimensiones positivas a:
\begin{itemize}
  \item joy
  \item trust
  \item positive
\end{itemize}   
  
Dimensiones neutrales:
\begin{itemize}
  \item anticipation
  \item suprise
\end{itemize} 

Dimensiones negativas:
\begin{itemize}
  \item anger
  \item disgust
  \item fear
  \item sadness
  \item negative
\end{itemize}  

```{r message=FALSE, warning=FALSE, include=FALSE}
library(syuzhet)

Sentiment_RS <- get_nrc_sentiment(articulos$titleArticle, language = "spanish")
Sentiment_A <- get_nrc_sentiment(articulos2$titleArticle, language = "spanish")

colSums(Sentiment_RS)
summary(Sentiment_RS)

negative=c("anger","disgust","fear","sadness","negative")
positive=c("joy","trust","positive")
neutral=c("anticipation","suprise")


sent_pos_rs=ifelse(
    Sentiment_RS$joy>0|Sentiment_RS$trust>0|Sentiment_RS$positive>0,
    rowSums(Sentiment_RS[,positive]),0)  
  
sent_neg_rs=ifelse(
  Sentiment_RS$anger>0|Sentiment_RS$disgust>0|Sentiment_RS$fear>0|Sentiment_RS$sadness>0
  |Sentiment_RS$negative>0,
-rowSums(Sentiment_RS[,negative]),0)

sent_pos_a=ifelse(
  Sentiment_A$joy>0|Sentiment_A$trust>0|Sentiment_A$positive>0,
  rowSums(Sentiment_A[,positive]),0)  

sent_neg_a=ifelse(
  Sentiment_A$anger>0|Sentiment_A$disgust>0|Sentiment_A$fear>0|Sentiment_A$sadness>0
  |Sentiment_A$negative>0,
  -rowSums(Sentiment_A[,negative]),0)

```

En función de estas agrupaciones, se llega a una conclusión similar a la del algoritmo del proyecto GDELT
en que el promedio para Robert Silva es negativo. 

El valor promedio de los sentimientos negativos es `r round(mean(sent_neg_rs),3)` y el de los sentimientos positivos `r round(mean(sent_pos_rs),3)`, por lo tanto, en los titulares asociados a Robert Silva predominan los sentimientos negativos. 

En los titulares asociados a ANEP, el valor promedio de los sentimientos negativos es `r round(mean(sent_neg_a),3)` y el de los sentimientos positivos `r round(mean(sent_pos_a),3)`, con lo que predominan los sentimientos positivos en los titulares de ANEP en promedio.


\newpage
```{r echo=FALSE, message=FALSE, warning=FALSE,out.width = "72%",fig.cap="",fig.align="center"}
data=data.frame(sent_neg_rs,sent_pos_rs,id_art=seq(1:length(sent_neg_rs)))
ggplot(data=data, aes(x=id_art)) +
  geom_point(y=sent_neg_rs,colour=8)+
  geom_point(y=sent_pos_rs,colour=4)+
  geom_line(y=mean(sent_neg_rs),colour=8)+
  geom_line(y=mean(sent_pos_rs),colour=4)+
  ggtitle("Análisis de sentimientos de las menciones a Robert Silva en Titulares") +
  labs(caption = "Líneas marcan el promedio del tono de las menciones.")+
  ylab("Indicador del sentimiento") + xlab("Identificador del Artículo y Titular") +
  ylim(-15, 15)

data=data.frame(sent_neg_a,sent_pos_a,id_art=seq(1:length(sent_neg_a)))
ggplot(data=data, aes(x=id_art)) +
  geom_point(y=sent_neg_a,colour=3)+
  geom_point(y=sent_pos_a,colour=2)+
  geom_line(y=mean(sent_neg_a),colour=3)+
  geom_line(y=mean(sent_pos_a),colour=2)+
  ggtitle("Análisis de sentimientos de las menciones a ANEP en Titulares") +
  labs(caption = "Líneas marcan el promedio del tono de las menciones.")+
  ylab("Indicador del sentimiento") + xlab("Identificador del Artículo y Titular") +
  ylim(-10, 15)

```






