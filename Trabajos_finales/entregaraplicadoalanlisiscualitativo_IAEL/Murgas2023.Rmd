---
title: Trabajo Final- Análisis de textos de murgas 2023, Iael Klaczko
subtitle: Curso R aplicado al análisis cualitativo, FCS
   
output: pdf_document 
urlcolor: blue
fontsize: 14pt
---

```{r echo=FALSE}
knitr::knit_hooks$set(mysize = function(before, options, envir) {
  if (before) 
    return(options$size)
})
```


```{r include=FALSE}
knitr::opts_chunk$set(mysize = TRUE, size = "\\small")

```
# Objetivos del trabajo

- Analizar los textos de las murgas de este año 
- Visualizar las diferencias entre murgas que llegan a la última etapa de la competencia y las que no
- Visualizar diferencias entre murgas que tienen integrantes mujeres y murgas que no

# Datos
Los datos a usar son las letras de las murgas que participan del carnaval 2023, como no se encuentran disponibles en ningún lado descargué todas las transcripciones de los espéctaculos de cada murga colgados en Youtube. Esto implica que puede haber palabras mal escritas o que no son tales, ya que surgen de un algoritmo que transforma voz en texto automáticamente en Youtube. 

Con las letras descargadas armé una tabla que contiene además de las letras, el nombre de la murga, la máxima etapa alcanzada (son tres etapas, ninguna quedó afuera en la primera, por lo que la variable toma dos valores: "segunda" y "liguilla"), y la cantidad de mujeres que integran cada murga. 

```{r include=FALSE}
knitr::opts_chunk$set(mysize = TRUE, size = "\\tiny")
#librerías generales

library(dplyr)
library(ggplot2)
library(readr)
library(quanteda) 
library(readtext) 
library(stringr)
library(quanteda.textstats)
library(quanteda.textplots)
library(gtrendsR)
library(ggrepel)
library(tmap)
library(syuzhet)
library(topicmodels)


#cargo la base que armé con las letras de murgas 2023

murgas <- read_csv("C:/Users/Usuario/OneDrive/quant/R/no estructurados/rcuali2022/trabajo final/LetrasMurgas23.csv")

#genero una variable que agrupa en tres categorías la presencia de mujeres en las murgas
murgas$fem<- ifelse(murgas$mujeres== 0, "sin mujeres", ifelse(murgas$mujeres<4, "<4 mujeres", "4o+ mujeres"))
save(murgas, file = "murgas.RData")

#limpio texto

dfm_murgas <- quanteda::dfm(quanteda::tokens(murgas$texto,
                                         remove_punct = TRUE,
                                         remove_numbers = TRUE),
                        tolower=TRUE,
                        verbose = FALSE) %>%
  quanteda::dfm_remove(pattern = c(quanteda::stopwords("spanish")),min_nchar=4) %>%
  quanteda::dfm_remove(c("musica","música","aplausos","carnaval","risas","murga","cómo"))

```
# Nubes de palabras
```{r echo=FALSE, message=FALSE, warning=FALSE, include=TRUE}
#nube de palabras general
quanteda.textplots::textplot_wordcloud(dfm_murgas, min.count = 2,max_words = 200,
                                       random.order = FALSE,colors = RColorBrewer::brewer.pal(8,"Dark2"),comparison = F)

quanteda::topfeatures(dfm_murgas,20)

```
Las palabras que más aparecen entre todas las letras son 'vamos', 'gente', 'bien'. 

Si miramos la nube de palabras de acuerdo a la máxima etapa alcanzada, las palabras que más se repiten en el caso de las murgas que pasaron a al liguilla son 'público', 'gente' palabras que refieren a grupos de personas. Mientras que las que más se repiten entre los textos de las murgas que no pasaron a la liguilla son 'feliz', 'verguenza', palabras que tienen que ver con sentimientos. 

```{r include=FALSE}
#nube de palabras según max etapa alcanzada
dfmg_murgas <- quanteda::dfm(quanteda::tokens(murgas$texto,
                                             remove_punct = TRUE,
                                             remove_numbers = TRUE),
                            tolower=TRUE,
                            verbose = FALSE) %>%
  quanteda::dfm_remove(pattern = c(quanteda::stopwords("spanish")),min_nchar=4) %>%
  quanteda::dfm_remove(c("musica","música","aplausos","carnaval","risas","murga","cómo")) %>% 
  quanteda::dfm_group(groups = murgas$etapa_max)
```
```{r echo=FALSE, warning=FALSE, include=TRUE}
quanteda.textplots::textplot_wordcloud(dfmg_murgas, min.count = 2,max_words = 200,
                                       random.order = FALSE,colors = RColorBrewer::brewer.pal(8,"Dark2"),comparison = T)

```

Al analizar la nube de palabras según murgas con distinta cantidaad de integrantes mujeres encontramos:

```{r include=FALSE}

#nube de palabras según presencia de mujeres 
dfmg_murgas <- quanteda::dfm(quanteda::tokens(murgas$texto,
                                              remove_punct = TRUE,
                                              remove_numbers = TRUE),
                             tolower=TRUE,
                             verbose = FALSE) %>%
  quanteda::dfm_remove(pattern = c(quanteda::stopwords("spanish")),min_nchar=4) %>%
  quanteda::dfm_remove(c("musica","música","aplausos","carnaval","risas","murga","cómo")) %>% 
  quanteda::dfm_group(groups = murgas$fem)
```

```{r echo=FALSE, warning=FALSE, message=FALSE, include=TRUE}
quanteda.textplots::textplot_wordcloud(dfmg_murgas, min.count = 2,max_words = 200,
                                       random.order = FALSE,colors = RColorBrewer::brewer.pal(6,"Dark2"),labelsize=1,comparison = T)
```

Las murgas sin mujeres están asociadas a las mismas palabras que las murgas que pasaron a la liguilla, ya que las palabras más repetidas son las mismas. Las murgas que están integradas por pocas mujeres utilizan mucho las palabras 'educación', 'deseo', 'todas'. Por su lado, las murgas que tienen más de 4 mujeres entre sus integrantes utilizan mucho las palabras 'villanos', 'verguenza' y 'bueno'. 

Es interesante hacer un análisis de sentimientos para ver si el texto de las murgas es mayoritariamente positivo, negativo o neutral. 

```{r include=FALSE}
# aplico diccionario existente para análisis de sentimientos
liwc <- readRDS("C:/Users/Usuario/OneDrive/quant/R/no estructurados/rcuali2022/trabajo final/EmoPosNeg_SPA.rds")

sent_dfm_murgas <- dfm_lookup(dfm_murgas, dictionary = liwc)
sent_murgas= cbind(murgas, convert(sent_dfm_murgas, to = "data.frame")) 

sent_murgas$puntaje <- sent_murgas$EmoPos-sent_murgas$EmoNeg
sent_murgas$sentimiento=ifelse(sent_murgas$puntaje<0,'negativo', ifelse(sent_murgas$puntaje== 0, 'neutral',
                                                                        ifelse(sent_murgas$puntaje<64, 'moderado', 'positivo'))) # 65 es el puntaje promedio
sentimiento_tabla <- sent_murgas %>% group_by(sentimiento,etapa_max,fem) %>% summarise(count=n()) %>% 
  mutate(per = prop.table(count)*100)
```

```{r echo= FALSE, warning=FALSE, message=FALSE, include=TRUE}

sentimiento_tabla
```
Hay sólo una murga, A la bartola, que tiene un texto preponderantemente negativo. Se trata de una de las murgas que más integrantes mujeres tiene y quedó afuera de la liguilla. 

Como la categorización en positivo/negativo sólo devolvería un texto como negativo, definí una categorización en tres, tomando como criterio el promedio de puntaje, aquellos textos que están por debajo del promedio son categorizados como 'moderado', los que están por arriba como 'positivo'. 

```{r echo=FALSE, include=TRUE}


ggplot(sentimiento_tabla, aes(x=etapa_max, y=per, fill=sentimiento))+
  geom_bar(position="dodge", stat="identity")+
  facet_grid(fem~., scales = 'free') +
  scale_fill_manual(values = c("#BCAFBD", "#9899E8","#B4CBD9"))

```

La mayoría de las murgas sin mujeres o con pocas (<4 mujeres) clasifican a la liguilla, sus textos son mayoritariamente positivos, los que no lo son, son moderadaos. En el caso de las murgas con mayor cantidad de mujeres la mayoría de los textos son moderados. 

Es interesante ver también ver cómo se asocian las palabras utilizadas por cada murga con palabras clave que tienen que ver con la actualidad de nuestro país y sobretodo lo que ocurrió durante el último año, que es en lo que se basan las murgas para armar sus espéctaculos. Voy a buscar asociaciones con las palabras: 'presidente', 'violencia', 'inseguridad', 'corrupción' y 'género'. 

```{r echo=FALSE, warning=FALSE, message=FALSE, include=TRUE}
# asociación de palabras 

quanteda.textstats::textstat_simil(dfm_murgas,selection = "presidente",
                                   method = "correlation",margin = "features")%>%
  as.data.frame()%>%
  dplyr::arrange(-correlation)%>%
  dplyr::top_n(15)
```
Presidente aparece asociado en los textos de las murgas a las palabras 'rompe', 'regresar' y 'próximo'. 
Violencia aparece asociada con 'pensamos', 'empiezo' y 'tablero'. 
Inseguridad se asocia con 'cámara', 'ilegal' y 'desafío'.
Corrupción se asocia con 'enero', 'penal' y 'europeo'. 
Por último, género se asocia con 'cifra', 'sospechar', 'cositas'.

Es bastante elocuente que presidente se asocie a palabras que dan la idea de recambio a futuro, violencia con la necesidad de pensar y empezar, inseguridad con cámaras y desafío, género con cifras, somo si sólo se tratara de números, con sospechas y con una palabra que se considera inocua y habilitante como 'cositas'.

Para finalizar analizo el contexto de las palabras mediante redes de co-ocurrencia, ya que suena razonable no sólo mirar palabras aisladas sino también junto con qué otras palabras se utilizan.

```{r echo=FALSE, warning=FALSE, message=FALSE, include=TRUE}
# redes de co-ocurrencia
base_fcm= dfm_murgas%>%
  fcm(context = "document")

feat <- names(topfeatures(base_fcm, 25))
base_fcm_select <- fcm_select(base_fcm, pattern = feat, selection = "keep")
size <- log(colSums(dfm_select(base_fcm, feat, selection = "keep")))

set.seed(144)
quanteda.textplots::textplot_network(base_fcm_select, min_freq = 0.8, vertex_size = size / max(size) * 3,
                                     edge_color="#ff9d5c")
```

La palabra 'vamos' se encuentra en el centro de la red, siendo la palabra que más conexión tiene con otras, principalmente con 'vida', 'ahora' y 'tiempo'. 




